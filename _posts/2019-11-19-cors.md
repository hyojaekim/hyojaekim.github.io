---
layout: post
title: "CORS 해결하기"
date: 2019-11-19 14:50:28 -0900
description: 프로젝트를 진행하면서 CORS 문제를 어떻게 해결했는지 공유하고자 합니다.
categories: etc
---

<div>
우아한테크코스 1기 과정을 진행하면서 사이드 프로젝트로 WoowaCrew를 만들고 있다. 구글 검색어 순위를 구현하기 위해서 아래와 같이 구현했다.

1. 검색한다.
2. 서버에 검색어를 저장한다.
3. 검색 결과를 보여주기 위해 Google로 리다이렉트 한다.

이렇게 했더니 아래와 같은 에러 메시지가 나왔다.

![cors-error](/assets/img/cors/cors-1.png)

**CORS** 라는 단어가 먼저 눈에 띄었다. 과정을 진행하면서 들어봤지만, 경험해본 적이 없어서 와닿지 않았는데 이번에 겪어보면서 글로 정리해놓으려고 한다. 먼저 CORS에 대해서 알아보자.
</div>
<div>
<blockquote>CORS (Cross Origin Resource Sharing)</blockquote>

![cors-2](/assets/img/cors/cors-2.png)

 HTTP 요청은 기본적으로 Cross-Site Http Requests 가 가능하지만, 자바스크립트로 다른 웹페이지에 접근할 때는 Same Origin Policy로 인해 요청이 불가능하다고 한다.

![cors-3](/assets/img/cors/cors-3.png)

**Same Origin Policy** 는 동일 출처 정책으로 자바스크립트(XMLHttpRequest)로 다른 웹 페이지에 접근할 때, 같은 출처(same origin)의 페이지만 접근이 가능하다.

자바스크립트 내에서 발생하는 **Cross-Site Http Requests** 는 프로토콜, 호스트, 포트가 같아야 요청을 할 수 있다. 즉, **요청하고자 하는 페이지와 같은 서버에 있는 주소로만 AJAX 요청이 가능** 하다.

여러 도메인에 대규모로 구성되는 웹 프로젝트가 많아지면서 해당 정책은 불편한 정책이라고 생각한다. 그래서 웹 브라우저에서 외부 도메인 서버와 통신하기 위한 방식을 표준화한 스펙이 CORS 이다. 서버는 클라이언트가 전송한 헤더를 확인하여 요청이나 응답을 어떻게 반응할지 결정하는 스펙이다.
</div>
<div>
<blockquote> 그래서 어떻게 해결했나? </blockquote>

문제를 해결하기 위한 방안은 여러 가지가 있었다.

### 외부 요청을 가능케 하는 플러그인 설치
웹 스토어에 **CORS** 로 검색하면 확장 프로그램을 설치하여 해결할 수 있다.

### 웹 브라우저 실행 시 옵션 사용
크롬 같은 웹 브라우저들은 실행 시 커맨드라인 옵션을 통해서 외부 도메인 요청 여부를 확인하는 동작을 무시하게 할 수 있다.
```
Chrome: --disable-web-security 옵션 추가하여 크롬 실행
```

### JSONP 방식으로 호출
정적 파일들은 도메인이 달라도 정책에 영향을 받지 않고 로딩이 가능한 점을 이용하여 외부에서 읽어온 JS 파일들을 JSON으로 바꿔주는 방식을 이용

### Server-side에서 처리
모든 요청의 응답에 아래 헤더를 추가한다.
```
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS (미설정 시 GET, POST만 가능)
Access-Control-Max-Age: 3600 (해당 시간 동안 Prelight 요청하지 않음)
Access-Control-Allow-Headers: Origin,Accept,X-Requested-With,Content-Type,Access-Control-Request-Method,Access-Control-Request-Headers,Authorization
```
</div>

<div>
4번 방법을 이용해서 서버에서 Response에 헤더에 하나하나 추가하다가 뭔가 스프링에서 해주는 것이 있을 것 같아서 다시 찾아봤다. 역시 있었다.

```java
@RestController
public class TestController {

    @CrossOrigin(origins = "http://localhost:8080")
    @GetMapping("/api/test")
    public RedirectView test() {

        ....
    }
}
```

**@CrossOrigin** 어노테이션에서 origins에는 **허용주소:포트** 를 입력하면 특정 도메인만 접속 허용할 수 있다.

```java
@RestController
@CrossOrigin(origins = "http://localhost:8080")
public class TestController {

    @GetMapping("/api/test")
    public RedirectView test() {

        ....
    }
}
```

위와 같이 컨트롤러 전체 API에 적용할 수도 있다.
또 다른 방법은 WebMvcConfigurer 인터페이스를 구현하는 방법이 있다.

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/test")
                .allowedOrigins("http://localhost:8080");
    }
}
```
이렇게 WebMvcConfigurer 인터페이스를 구현해서 하나의 클래스에서 관리할 수도 있다. 상황에 맞게 사용하도록 하자.
</div>
